
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    
    <title>RQuery: refactored and simplified</title>
    
    
    <meta name="author" content="John Bender">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="//johnbender.github.com/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="//johnbender.github.com/assets/themes/twitter/css/style.css" rel="stylesheet" type="text/css" media="all">
    <link href="//johnbender.github.com/assets/themes/twitter/css/cv.css" rel="stylesheet" type="text/css" media="all">
    <link href="//johnbender.github.com/assets/themes/twitter/css/font-awesome.min.css" rel="stylesheet" type="text/css" media="all">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="//johnbender.github.com">johnbender.us</a>
          <ul class="nav">
            
            
            


  
    
      
    
  
    
      
      	
        <li><a href="//johnbender.github.com/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
  
    
      
    
  
    
      
      	
        <li><a href="//johnbender.github.com/cv.html">Curriculum Vitae</a></li>
      	
      
    
  
    
      
      	
        <li><a href="//johnbender.github.com/portfolio.html">Portfolio</a></li>
      	
      
    
  



          </ul>

          <div class="social-media">
            <a href="http://twitter.com/johnbender">
              <i class="icon-twitter-sign"></i>
            </a>
            <a href="http://github.com/johnbender">
              <i class="icon-github-sign"></i>
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="content">
        
<div class="page-header">
  <h1>RQuery: refactored and simplified</h1>
</div>

<div class="row-fluid">
  <div class="span10 text">
    I've gone back and knocked off a couple of big todos in rquery. Namely, removing the Symbol capability, and using instances of the new OperationCollector in place of the global class variable + mutex required by the Symbol alterations. Also, as a consequence, I was able to remove the Declarations methods ( .is, .is_not )  previously required for use with overloaded operators like ==.

<h2>No More Symbols</h2>

Previously there were two DSLs coexisting in the library. One opened up the Symbol class and added the  declaration methods.

<pre>
<span class="type">User</span>.where { <span class="constant">:age</span>.is == 12 }
</pre><br />

This, in my opinion, was an interesting hack and fun to implement but required both global storage for the results of the executing statements and the pollution of the Symbol class. The library's better half used a block parameter that represented a collection of the attributes provided by ActiveRecord.

<pre>
<span class="type">User</span>.where { |user| user.age.is == 12 }
</pre><br />

In removing support for the Symbol based syntax, the block based version became much cleaner both externally and internally. Externally there's no longer a need for the .is and .is_not declarations while the from, between, in and contains methods remain the same.

<pre>
<span class="type">User</span>.where <span class="keyword">do</span> |user|
  user.age == 12
  user.name.contains <span class="string">"George"</span>
  user.weight.between 160..180
<span class="keyword">end</span>
</pre><br />

Though, because of Ruby's restriction on overloading the != operator it now looks like:

<pre>
<span class="type">User</span>.where <span class="keyword">do</span> |user|
  user.age.not = 12
<span class="keyword">end</span>
</pre><br />

<h2>Simple Internals</h2>

The internals have been simplified as well. At a glance, there is now a single class that handles the organization of the calls to the adapter for serialization, OperationCollector. In addition every time the where method is called, a new instance of this class is created so there's no need to have the mutex to prevent race conditions. Please take a look at the <a href="http://github.com/johnbender/rquery/tree/master">newness</a> for more details.

    
  </div>

  <div id="info" class="span2">
  

    <h4>Published</h4>
    <div class="date"><span>22 Aug 2009</span></div>

  
    <h4>Tags</h4>
    <ul class="tag_box">
    
    


  
    
    	<li><a href="/archive.html#ruby">ruby <span>12</span></a></li>
    
  



    </ul>
  
  </div>
</div>


      </div>

    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="//johnbender.github.com/2009/08/14/unraverl-partial-function-application" title="Unraverl: Partial Function Application">&larr; Previous</a></li>
      
        <li><a href="//johnbender.github.com/archive.html">Archive</a></li>
      
        <li class="next"><a href="//johnbender.github.com/2009/09/12/algebra-of-programming-chapter-1" title="Algebra of Programming: Chapter 1 Section 2">Next &rarr;</a></li>
      
      </ul>
    </div>

    <footer>
      <p>&copy; John Bender 2012
        with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
        and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
      </p>
    </footer>

    </div>

    


  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-21257360-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>




  </body>
</html>

