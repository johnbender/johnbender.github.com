
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    
    <title>A Better SQL, Part 1</title>
    
    
    <meta name="author" content="John Bender">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="//johnbender.github.com/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="//johnbender.github.com/assets/themes/twitter/css/style.css" rel="stylesheet" type="text/css" media="all">
    <link href="//johnbender.github.com/assets/themes/twitter/css/cv.css" rel="stylesheet" type="text/css" media="all">
    <link href="//johnbender.github.com/assets/themes/twitter/css/font-awesome.min.css" rel="stylesheet" type="text/css" media="all">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body class="">
    <a href="https://plus.google.com/112550334078819814430?rel=author" style="display:none">Google</a>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="//johnbender.github.com">johnbender.us</a>
          <ul class="nav">
            
            
            


  
    
      
    
  
    
      
      	
        <li><a href="//johnbender.github.com/portfolio.html">Portfolio</a></li>
      	
      
    
  
    
      
      	
        <li><a href="//johnbender.github.com/archive.html">Archive</a></li>
      	
      
    
  
    
  
    
  
    
      
    
  
    
      
    
  
    
      
      	
        <li><a href="//johnbender.github.com/cv.html">Curriculum Vitae</a></li>
      	
      
    
  



          </ul>

          <div class="social-media">
            <a href="http://twitter.com/johnbender">
              <i class="icon-twitter-sign"></i>
            </a>
            <a href="http://github.com/johnbender">
              <i class="icon-github-sign"></i>
            </a>
            <a href="https://plus.google.com/112550334078819814430" rel="publisher">
              <i class="icon-google-plus-sign"></i>
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="content">
        
<div class="page-header">
  <h1>A Better SQL, Part 1</h1>
</div>

<div class="row-fluid">
  <div class="span10 text">
    <p>The relational model for data is ubiquitous. That&#39;s in part due to SQL&#39;s declarative approach to dealing with data. Unfortunately SQL has its warts. In particular schema change with the data definition subset of the language (DDL) [1] can be awkward for creating idempotent migrations. It&#39;s awkward enough that the responsibility is frequently delegated to the application layer where more expressive languages can be employed. In this, the first of two posts proposing improvements to SQL, I&#39;ll lay out an alternate semantics for SQL DDL that embraces schema change and expands the expressive power of DDL&#39;s declarative core.</p>

<h2 id="toc_59">A Common Activity</h2>

<p>To illustrate how schema changes break the initially declarative semantics of DDL, lets look at an example:</p>
<div class="highlight"><pre><code class="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">foo</span> <span class="p">(</span>
  <span class="n">bar</span> <span class="nb">int</span><span class="p">,</span>
  <span class="n">baz</span> <span class="nb">text</span>
<span class="p">);</span>
</code></pre>
</div>

<p>All tables start this way. The only piece of syntax that might otherwise alert a new user to the fact that this is not an entirely descriptive declarative language is <code>create</code>. The definition is very much &quot;what&quot; is desired and not &quot;how&quot; to get it. This breaks down when anything about the table needs to change:</p>
<div class="highlight"><pre><code class="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">foo</span> <span class="p">(</span>
  <span class="n">bar</span> <span class="nb">int</span><span class="p">,</span>
  <span class="n">baz</span> <span class="nb">text</span>
<span class="p">);</span>

<span class="k">alter</span> <span class="k">table</span> <span class="n">foo</span> <span class="k">add</span> <span class="k">column</span> <span class="n">bak</span> <span class="nb">text</span><span class="p">;</span>
</code></pre>
</div>

<p>All together this will ensure the proper end-state whether the target database is at the initial state without the table <code>foo</code> or at the second state where <code>foo</code> lacks the column <code>bak</code>. In this case it&#39;s easy to understand the final state of the table because the example is very simple, but it&#39;s acquired an imperative pall with the inclusion of the first <code>alter</code>. As the schema definition grows more complex through many <code>drop</code>, <code>add</code>, and type cast changes, the final state of the table becomes less clear:</p>
<div class="highlight"><pre><code class="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">foo</span> <span class="p">(</span>
  <span class="n">bar</span> <span class="nb">int</span><span class="p">,</span>
  <span class="n">baz</span> <span class="nb">text</span>
<span class="p">);</span>

<span class="k">alter</span> <span class="k">table</span> <span class="n">foo</span> <span class="k">add</span> <span class="k">column</span> <span class="n">bak</span> <span class="nb">text</span><span class="p">;</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">foo</span> <span class="k">drop</span> <span class="k">column</span> <span class="n">bak</span> <span class="nb">text</span><span class="p">;</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">foo</span> <span class="k">add</span> <span class="k">column</span> <span class="n">baks</span> <span class="nb">text</span><span class="p">;</span>
</code></pre>
</div>

<p>It would be better to simply add columns to the original table definition, and then the shape of the resulting table would be immediately clear at a glance.</p>

<h2 id="toc_60">Differential Semantics</h2>

<p>In our toy example the desired table definition included a new column <code>bak</code>. An entirely descriptive update to the table declaration would look like this (Note that the original alter statement is absent):</p>
<div class="highlight"><pre><code class="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">foo</span> <span class="p">(</span>
  <span class="n">bar</span> <span class="nb">int</span><span class="p">,</span>
  <span class="n">baz</span> <span class="nb">text</span><span class="p">,</span>
  <span class="n">bak</span> <span class="nb">text</span>
<span class="p">);</span>
</code></pre>
</div>

<p>Unfortunately the SQL runtime considers the syntax in isolation and makes no attempt to reconcile that with it&#39;s internal representation. That makes perfect sense because a user is permitted to run small, ad hoc snippets in addition to full schema migration scripts. That is, the RDBMS can&#39;t know where this declaration is coming from nor why it&#39;s being run so it&#39;s unsafe to assume it should do any reconciliation. In contrast a well outfitted user can provide exactly that information.</p>
<div class="highlight"><pre><code class="diff"><span class="gu">@@ -1,4 +1,5 @@</span>
 create table foo (l;
   bar int,
<span class="gd">-  baz text</span>
<span class="gi">+  baz text,</span>
<span class="gi">+  bak text</span>
 );
</code></pre>
</div>

<p>Looking at the diff, it&#39;s clear that the intention is to add the column <code>bak</code> to the table. What&#39;s required then, is to assign some semantics to this diff. With that established a simple pre-processor could map this differential to the corresponding alter statement in DDL, namely the original alter statement.</p>

<p>The key insight here is that we can permit schema migrations while retaining an entirely descriptive declarative syntax by appealing to the differential information available via source control tools.</p>

<h2 id="toc_61">Value Proposition</h2>

<p>The basic value proposition is reduced cognitive overhead when maintaining schemas using SQL DDL. In addition, DDL&#39;s syntax is reduced by about half because alters and drops [2] can simply go away which should make it easier to learn [3].</p>

<p>This could also be pushed up the stack to migration tools by an enterprising library or framework author. For example, Rails generates and maintains a <code>db/schema.rb</code> file that is supposed to represent the state of the schema for the associated migrations. A similar technique could be applied there to divine the appropriate alterations when an change to that file is made in place of using migrations for schema changes.</p>

<p>Finally, by associating meaning with syntactic change the user can more safely understand and execute post commit reverts to schema changes. That is, instead of manually defining the necessary steps to &quot;undo&quot; some previous schema change, the source control system can provide the exact information that is necessary.</p>

<h2 id="toc_62">Pitfalls</h2>

<p>Obviously, not every migration is just about the schema. Frequently the data has to be altered to conform to the target schema. This is actually an area of active research in the Database Systems community [4].</p>

<h2 id="toc_63">Conclusion</h2>

<p>For the interested reader, I started work on a <a href="https://github.com/johnbender/sql-delta">preprocessor</a> implemented in Haskell. Unfortunately since I don&#39;t have any plans to pursue this further I haven&#39;t been working on it. Also, for comparison I&#39;ve included two very simple sets of denotational semantics in the footnotes; one to represent the current implementation and one to represent the differential semantics [5]. They highlight the symmetry of this new approach to the language when compared with the current implementation.</p>

<p>This technique can be extended to other languages that manage system state declaratively like configuration management DSLs or even HTML. Though in the case of configuration management, understanding the mapping between syntax and state is quite complex because system components frequently generate artifacts that are not explicitly declared.</p>

<p>Broadly, the idea of differential semantics is to gather more information about intent from readily available sources so that language runtimes (declarative or otherwise) can make more informed decisions about user intent. The results need not be confined to accurate interpretation of the desired system state.</p>

<p>In the next post we&#39;ll look at how a type system applied to SQL might provide some useful safety properties during schema migration and beyond.</p>

<h3 id="toc_64">Footnotes</h3>

<ol>
<li><a href="http://en.wikipedia.org/wiki/Data_definition_language">http://en.wikipedia.org/wiki/Data_definition_language</a></li>
<li>In our example a drop would be accomplished by removing the table definition completely.</li>
<li>The mapping presumes feature parity in the create with the alter statements, but in my study of the standard and Postgres&#39; implementation this appears to be the case.</li>
<li>There&#39;s a lot of interesting work and tooling around preventing issues resulting from schema migrations: <a href="http://scholar.google.com/scholar?q=prism+schema+evolution&amp;btnG=&amp;hl=en&amp;as_sdt=0%2C5">schema evolution</a>.</li>
<li>A denotational semantics for both the current DDL semantics and the proposed semantics. Note that in the proposed section the &quot;differential&quot; semantics eval function is parameterized by the state of the syntax.</li>
</ol>

<p><p  style=" margin: 12px auto 6px auto; font-family: Helvetica,Arial,Sans-serif; font-style: normal; font-variant: normal; font-weight: normal; font-size: 14px; line-height: normal; font-size-adjust: none; font-stretch: normal; -x-system-font: none; display: block;">   <a title="View SQL DDL Differential Semantics on Scribd" href="http://www.scribd.com/doc/181098166/SQL-DDL-Differential-Semantics"  style="text-decoration: underline;" >SQL DDL Differential Semantics</a></p><iframe class="scribd_iframe_embed" src="//www.scribd.com/embeds/181098166/content?start_page=1&view_mode=scroll&show_recommendations=true" data-auto-height="false" data-aspect-ratio="undefined" scrolling="no" id="doc_64435" width="100%" height="600" frameborder="0"></iframe></p>

    
  </div>

  <div id="info" class="span2">
  

    <h4>Published</h4>
    <div class="date"><span>04 Nov 2013</span></div>

  
    <h4>Tags</h4>
    <ul class="tag_box">
    
    


  
    
    	<li><a href="/archive.html#sql">sql <span>1</span></a></li>
    
  



    </ul>
  
  </div>
</div>


      </div>

      

    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="//johnbender.github.com/2013/09/16/why-im-getting-a-phd" title="Why I'm Getting a PhD">&larr; Older</a></li>
      
        <li><a href="//johnbender.github.com/archive.html">Archive</a></li>
      
        <li class="next disabled"><a>Newer &rarr;</a>
      
      </ul>
    </div>

    <footer>
      <p>&copy; John Bender 2012
        with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
        and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
      </p>
    </footer>

    </div>

    


  <!-- -->
  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-21257360-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>




  </body>
</html>

